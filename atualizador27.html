<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atualizador Delta Metas - Unificado</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --button-normal: #bbbbbb;
      --button-hover: #87CEFA;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      padding: 20px;
      color: var(--dark-color);
      min-height: 100vh;
    }
    
    h1 {
      font-size: 2.2rem;
      margin-bottom: 25px;
      color: var(--primary-color);
      text-align: center;
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    button {
      padding: 10px 18px;
      font-size: 0.9rem;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-weight: 500;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      opacity: 0.9;
    }
    
    .action-button {
      background: var(--button-normal);
    }
    
    .action-button:hover {
      background: var(--button-hover);
    }
    
    #upload-section, #dashboard {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      margin: 25px auto;
      max-width: 1200px;
      padding: 25px;
      position: relative;
    }
    
    #dashboard {
      display: none;
    }
    
    .meta-and-steps {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding: 12px;
      margin-bottom: 20px;
    }
    
    .meta-button {
      width: 170px;
      flex: 0 0 170px;
      border: 1px solid #ddd;
      border-radius: 8px;
      text-align: center;
      padding: 12px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      font-size: 0.85rem;
    }
    
    .meta-button:hover {
      opacity: 0.95;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .meta-button[contenteditable="true"] {
      border: 2px dashed var(--secondary-color);
      outline: none;
    }
    
    .passo {
      width: 170px;
      flex: 0 0 170px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      text-align: left;
      padding: 12px;
      position: relative;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      min-height: 110px;
    }
    
    .passo[contenteditable="true"] {
      border: 2px dashed var(--secondary-color);
      outline: none;
    }
    
    /* Estilo para destacar o passo atual */
    .passo.current-step {
      border-left: 4px solid #4CAF50;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }
    
    .passo h4 {
      margin: 0 0 6px;
      font-size: 0.85rem;
    }
    
    .passo h4[contenteditable="true"] {
      border-bottom: 1px dashed var(--secondary-color);
      outline: none;
    }

    .passo p {
      font-size: 0.78rem;
      word-wrap: break-word;
      margin: 0;
    }
    
    .passo p[contenteditable="true"] {
      border: 1px dashed var(--secondary-color);
      padding: 2px;
      outline: none;
    }

    .passo .comentario {
      color: red;
      font-size: 0.72rem;
      margin-top: 6px;
      font-style: italic;
    }
    
    .passo .comentario[contenteditable="true"] {
      border: 1px dashed var(--secondary-color);
      padding: 2px;
      outline: none;
    }
    
    .delete-step-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--danger-color);
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.3s;
    }
    
    .delete-step-btn:hover {
      background: rgba(231, 76, 60, 0.1);
    }
    
    .add-step-btn {
      width: 100%;
      background: var(--button-normal);
      color: white;
      padding: 4px;
      margin-top: 8px;
      font-size: 0.7rem;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .add-step-btn:hover {
      background: var(--button-hover);
    }
    
    .comentario {
      color: var(--danger-color) !important;
      margin-top: 12px;
      font-style: italic;
      padding: 8px;
      background: rgba(231, 76, 60, 0.05);
      border-radius: 6px;
      font-size: 0.85rem;
    }
    
    .dashboard-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
      gap: 10px;
    }
    
    .post-it {
      background: #fffacd;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #f0e68c;
      margin-top: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    #save-btn {
      background: var(--success-color);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transform: translateX(120%);
      transition: transform 0.3s ease-in-out;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.info {
      background-color: var(--secondary-color);
    }
    
    .notification.success {
      background-color: var(--success-color);
    }
    
    .notification.error {
      background-color: var(--danger-color);
    }
    
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .confirmation-modal.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .confirmation-content {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
    }
    
    .confirmation-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }
    
    ::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    .group-section {
      margin-bottom: 25px;
      border-radius: 10px;
      overflow: hidden;
      background: white;
      border: 1px solid #e0e0e0;
    }
    
    .group-header {
      padding: 12px 16px;
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .group-header[contenteditable="true"] {
      border: 2px dashed white;
      outline: none;
    }
    
    .group-actions {
      display: flex;
      gap: 8px;
      margin-left: 10px;
    }
    
    .add-meta-btn {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .add-meta-btn:hover {
      background: rgba(255,255,255,0.5);
    }
    
    .delete-group-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .delete-group-btn:hover {
      background: rgba(255,255,255,0.4);
    }

    /* Estilos para imagens */
    .step-thumbnails {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
      justify-content: center;
    }

    .thumbnail-container {
      position: relative;
      margin-bottom: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      width: 50px;
      height: 50px;
      background: #f5f5f5;
    }

    .step-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }

    .thumbnail-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 8px;
      padding: 2px;
      text-align: center;
      word-wrap: break-word;
      max-height: 20px;
      overflow: hidden;
    }

    .add-image-btn {
      background: var(--button-normal);
      color: white;
      padding: 3px 6px;
      font-size: 0.7rem;
      margin-top: 6px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      display: block;
    }

    /* Modal de imagem */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      right: 10px;
      top: 5px;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    .image-preview {
      max-width: 100%;
      max-height: 400px;
      display: block;
      margin: 0 auto 15px;
      border: 1px solid #ddd;
    }

    .caption-input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
    }

    .save-btn {
      background-color: #27ae60;
    }

    .delete-btn {
      background-color: #e74c3c;
    }

    .cancel-btn {
      background-color: #95a5a6;
    }

    /* PDF Modal */
    .pdf-modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }

    .pdf-modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
    }

    .pdf-option {
      margin: 15px 0;
    }

    .pdf-groups {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .pdf-group-item {
      margin: 8px 0;
      display: flex;
      align-items: center;
    }

    .pdf-group-item input {
      margin-right: 10px;
    }

    .pdf-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    /* Estilos para o relatório PDF */
    .pdf-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .pdf-title {
      color: #2c3e50;
      font-size: 24pt;
      margin-bottom: 15px;
    }
    
    .pdf-subtitle {
      color: #34495e;
      font-size: 16pt;
      margin-bottom: 25px;
    }
    
    .pdf-info {
      color: #7f8c8d;
      font-size: 12pt;
      margin-bottom: 15px;
    }
    
    .pdf-group {
      margin-bottom: 40px;
      page-break-before: always;
    }
    
    .pdf-group-header {
      font-size: 20pt;
      padding: 10px 15px;
      margin-bottom: 25px;
      color: white;
      border-radius: 5px;
    }
    
    .pdf-goal {
      margin-bottom: 30px;
      page-break-inside: avoid;
    }
    
    .pdf-goal-title {
      font-size: 16pt;
      padding: 8px;
      margin-bottom: 20px;
      color: white;
      border-radius: 5px;
    }
    
    .pdf-step {
      margin-left: 20px;
      margin-bottom: 25px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #eee;
      page-break-inside: avoid;
    }
    
    /* Estilo para o passo atual no PDF */
    .pdf-step-current {
      background-color: #f9f9f9 !important;
      border-left: 5px solid #4CAF50 !important;
    }
    
    .pdf-step-content {
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .pdf-step-comment {
      color: #e74c3c;
      font-style: italic;
      margin-top: 15px;
      font-size: 11pt;
      line-height: 1.4;
    }
    
    .pdf-images {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
      page-break-inside: avoid;
    }
    
    .pdf-image-container {
      width: calc(50% - 10px);
      margin-bottom: 20px;
      page-break-inside: avoid;
    }
    
    .pdf-image {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      page-break-inside: avoid;
    }
    
    .pdf-caption {
      text-align: center;
      font-size: 10pt;
      color: #555;
      margin-top: 10px;
      line-height: 1.4;
    }

    /* Input para nova meta */
    .new-meta-input {
      width: 170px;
      flex: 0 0 170px;
      border: 2px dashed var(--secondary-color);
      border-radius: 8px;
      text-align: center;
      padding: 12px;
      color: var(--secondary-color);
      font-size: 0.85rem;
      background: white;
      outline: none;
      margin-left: 15px;
    }
    
    /* Botão para adicionar grupo */
    .add-group-btn {
      background: var(--success-color);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
    }

    /* Modal de verificação de passo anterior */
    .step-status-modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }

    .step-status-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
      text-align: center;
    }

    .step-status-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      #upload-section, #dashboard {
        padding: 18px 12px;
      }
      
      .meta-button, .passo {
        width: 180px;
      }
      
      .dashboard-actions {
        flex-direction: column;
      }
      
      .modal-content {
        width: 95%;
        margin: 20% auto;
      }
      
      .pdf-modal-content {
        width: 95%;
        margin: 20% auto;
      }
      
      .thumbnail-container {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <h1>Atualizador Delta Metas - Unificado</h1>
  
  <div id="notification-area"></div>
  
  <div id="confirmation-modal" class="confirmation-modal">
    <div class="confirmation-content">
      <h3 id="confirmation-title">Excluir Grupo</h3>
      <p id="confirmation-message">Deseja realmente excluir este grupo?</p>
      <p id="confirmation-dashboard-question" style="display:none;">Deseja excluir também do dashboard?</p>
      <div class="confirmation-buttons">
        <button id="confirm-delete-group" class="action-button">Sim</button>
        <button id="confirm-delete-no-dashboard" class="action-button">Não</button>
        <button id="confirm-cancel" class="action-button">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de verificação de status do passo anterior -->
  <div id="step-status-modal" class="step-status-modal">
    <div class="step-status-content">
      <h3>Status do Passo Anterior</h3>
      <p>O passo anterior foi executado?</p>
      <div class="step-status-options">
        <button id="step-status-yes" class="modal-btn save-btn">Sim</button>
        <button id="step-status-no" class="modal-btn delete-btn">Não</button>
      </div>
    </div>
  </div>

  <div id="upload-section">
    <h2>Carregar HTML do DeltaMetas</h2>
    <div style="text-align:center;">
      <button id="load-html-btn" class="action-button">Carregar HTML</button>
      <input type="file" id="html-file-input" accept=".html" style="display:none;"/>
    </div>
  </div>

  <div id="dashboard">
    <div class="dashboard-actions">
      <button id="add-group-btn" class="add-group-btn"><i class="fas fa-plus-circle"></i> Adicionar Novo Grupo</button>
      <button id="save-btn" class="action-button">Gerar Código Atualizado</button>
      <button id="generate-pdf-btn" class="action-button">Gerar PDF</button>
    </div>
    <h2 style="text-align: center; margin-bottom: 25px;">Dashboard de Monitoramento</h2>
    <div id="dashboard-content"></div>
  </div>

  <!-- Modal de adicionar/editar imagem -->
  <div id="image-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modal-title">Adicionar Imagem</h3>
      <div>
        <img id="image-preview" class="image-preview" src="#" alt="Prévia da imagem">
        <input type="file" id="image-input" accept="image/*" style="display:none;">
        <button id="select-image-btn" style="margin: 10px auto; display: block;">Selecionar Imagem</button>
      </div>
      <div>
        <label for="caption-input">Legenda:</label>
        <input type="text" id="caption-input" class="caption-input" placeholder="Descreva a imagem...">
      </div>
      <div class="modal-footer">
        <button id="save-image-btn" class="modal-btn save-btn">Salvar</button>
        <button id="delete-image-btn" class="modal-btn delete-btn" style="display:none;">Excluir</button>
        <button id="cancel-image-btn" class="modal-btn cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de criação de novo passo -->
  <div id="new-step-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="close-step-modal">&times;</span>
      <h3>Adicionar Novo Passo</h3>
      <div style="margin-bottom: 15px;">
        <label for="new-step-activity">Conteúdo do Passo:</label>
        <textarea id="new-step-activity" style="width: 100%; padding: 8px; margin-top: 5px; height: 80px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="new-step-comment">Comentário (opcional):</label>
        <textarea id="new-step-comment" style="width: 100%; padding: 8px; margin-top: 5px; height: 60px; border-radius: 4px; border: 1px solid #ddd; color: #e74c3c;"></textarea>
      </div>
      <div class="modal-footer">
        <button id="save-step-btn" class="modal-btn save-btn">Salvar</button>
        <button id="cancel-step-btn" class="modal-btn cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de criação de nova meta -->
  <div id="new-meta-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="close-meta-modal">&times;</span>
      <h3>Adicionar Nova Meta</h3>
      <div style="margin-bottom: 15px;">
        <label for="new-meta-name">Nome da Meta:</label>
        <input type="text" id="new-meta-name" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ddd;">
      </div>
      <div style="margin-bottom: 15px;">
        <label for="new-meta-activity">Conteúdo:</label>
        <textarea id="new-meta-activity" style="width: 100%; padding: 8px; margin-top: 5px; height: 80px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
      </div>
      <div style="margin-bottom: 15px;">
        <label for="new-meta-comment">Comentário (opcional):</label>
        <textarea id="new-meta-comment" style="width: 100%; padding: 8px; margin-top: 5px; height: 60px; border-radius: 4px; border: 1px solid #ddd; color: #e74c3c;"></textarea>
      </div>
      <div class="modal-footer">
        <button id="save-meta-btn" class="modal-btn save-btn">Salvar</button>
        <button id="cancel-meta-btn" class="modal-btn cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de geração de PDF -->
  <div id="pdf-modal" class="pdf-modal">
    <div class="modal-content pdf-modal-content">
      <span class="close" id="close-pdf-modal">&times;</span>
      <h3>Gerar Relatório em PDF</h3>
      
      <div class="pdf-option">
        <input type="radio" name="pdf-type" id="pdf-all" checked>
        <label for="pdf-all">Relatório Completo (todos os grupos)</label>
      </div>
      
      <div class="pdf-option">
        <input type="radio" name="pdf-type" id="pdf-select-groups">
        <label for="pdf-select-groups">Selecionar grupos</label>
      </div>
      
      <div id="pdf-groups-selection" class="pdf-groups" style="display:none;">
        <!-- Grupos serão inseridos dinamicamente -->
      </div>
      
      <div class="pdf-actions">
        <button id="generate-pdf-confirm" class="modal-btn save-btn">Gerar PDF</button>
        <button id="cancel-pdf" class="modal-btn cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>
  <script>
    const colorMap = {
      'demanda-1': '#FAD02E',
      'demanda-2': '#F28D35',
      'demanda-3': '#D83367',
      'demanda-4': '#B2B8B5',
      'demanda-5': '#98B6E7',
      'demanda-6': '#80D8A8',
      'demanda-7': '#F0E9D2'
    };

    let parsedDoc;
    let originalActivities = new Map();
    let customGroups = [];
    let colorCache = new Map();
    let unsavedChanges = false;
    let currentDeletionContext = null;
    let currentImageEditContext = null;
    let currentStepContext = null;
    let currentMetaContext = null;
    let previousStepElement = null; // Para armazenar referência ao passo anterior
    
    // Dados do usuário e data atual atualizados
    const currentUser = "adrianodamato20152015";
    const currentDate = "2025-08-04 11:25:20";
    
    // Função para gerar IDs únicos para os passos
    function generateUniqueId() {
      return 'step_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
    }
    
    // Garantir que todos os passos tenham IDs
    function ensureStepIds() {
      if (!parsedDoc) return;
      
      const allSteps = parsedDoc.querySelectorAll('.passo');
      allSteps.forEach(step => {
        if (!step.dataset.stepId) {
          step.dataset.stepId = generateUniqueId();
          unsavedChanges = true;
        }
      });
    }
    
    function showNotification(message, type = 'info', duration = 3000) {
      const notificationArea = document.getElementById('notification-area');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notificationArea.appendChild(notification);
      
      void notification.offsetWidth;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, duration);
    }
    
    function showConfirmation(title, message, callback) {
      const modal = document.getElementById('confirmation-modal');
      const titleElement = document.getElementById('confirmation-title');
      const messageElement = document.getElementById('confirmation-message');
      const dashboardQuestion = document.getElementById('confirmation-dashboard-question');
      const confirmYesBtn = document.getElementById('confirm-delete-group');
      const confirmNoBtn = document.getElementById('confirm-delete-no-dashboard');
      const confirmCancelBtn = document.getElementById('confirm-cancel');
      
      // Configuração inicial para a primeira pergunta
      titleElement.textContent = title;
      messageElement.textContent = message;
      dashboardQuestion.style.display = 'none';
      
      // Configurar os botões para a primeira pergunta
      confirmYesBtn.textContent = 'Sim';
      confirmNoBtn.style.display = 'none';
      confirmCancelBtn.textContent = 'Cancelar';
      
      // Exibir o modal
      modal.classList.add('visible');
      
      // Limpar quaisquer listeners anteriores
      confirmYesBtn.onclick = null;
      confirmNoBtn.onclick = null;
      confirmCancelBtn.onclick = null;
      
      // Configurar listeners para a primeira pergunta
      confirmYesBtn.onclick = () => {
        modal.classList.remove('visible');
        callback(true);
      };
      
      // Se cancelar na primeira pergunta, não fazer nada
      confirmCancelBtn.onclick = () => {
        modal.classList.remove('visible');
      };
    }

    function getGroupColor(groupId) {
      if (colorCache.has(groupId)) return colorCache.get(groupId);
      
      if (groupId === 'administrativo') {
        colorCache.set(groupId, '#FAD02E');
        return '#FAD02E';
      }
      
      const button = parsedDoc.querySelector(
        `#tela-inicial .quadrante[onclick*="mostrarSubTela('${groupId}')"]`
      );
      
      if (!button) return '#3498db';

      for (const className of button.classList) {
        if (colorMap[className]) {
          colorCache.set(groupId, colorMap[className]);
          return colorMap[className];
        }
      }
      
      const inlineColor = button.style.backgroundColor;
      if (inlineColor) {
        colorCache.set(groupId, inlineColor);
        return inlineColor;
      }
      
      return '#3498db';
    }

    function addNewGroup() {
      const groupName = prompt("Digite o nome do novo grupo:");
      if (!groupName || !groupName.trim()) return;

      const groupId = 'custom-' + groupName
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^\w-]/g, '');
      
      const hue = Math.floor(Math.random() * 360);
      const color = `hsl(${hue}, 70%, 85%)`;
      
      customGroups.push({
        id: groupId,
        name: groupName,
        color: color
      });
      
      if (!parsedDoc.getElementById(groupId)) {
        const newGroupHTML = `
          <div id="${groupId}" class="sub-container">
            <div class="titulo">${groupName}</div>
            <div class="container"></div>
            <div class="voltar" onclick="voltarTela('tela-inicial')">Voltar</div>
          </div>
        `;
        
        const telaInicial = parsedDoc.getElementById('tela-inicial');
        if (telaInicial) {
          const btnContainer = document.createElement('div');
          btnContainer.className = 'button-container';
          btnContainer.dataset.meta = groupId;

          const newButton = document.createElement('div');
          newButton.className = 'quadrante';
          newButton.style.backgroundColor = color;
          newButton.setAttribute('onclick', `mostrarSubTela('${groupId}')`);
          newButton.innerHTML = `<div class="titulo">${groupName}</div>`;

          btnContainer.appendChild(newButton);
          telaInicial.appendChild(btnContainer);
          parsedDoc.body.insertAdjacentHTML('beforeend', newGroupHTML);
        }
      }
      
      // Atualizar o dashboard com o novo grupo
      const dashboardContent = document.getElementById('dashboard-content');
      
      const groupSection = document.createElement('div');
      groupSection.className = 'group-section';
      groupSection.dataset.group = groupId;
      
      const groupHeader = document.createElement('div');
      groupHeader.className = 'group-header';
      groupHeader.style.backgroundColor = color;
      groupHeader.textContent = groupName;
      groupHeader.addEventListener('dblclick', enableEditingForElement);
      
      const groupActions = document.createElement('div');
      groupActions.className = 'group-actions';
      
      const addMetaBtn = document.createElement('button');
      addMetaBtn.className = 'add-meta-btn';
      addMetaBtn.innerHTML = '<i class="fas fa-plus"></i>';
      addMetaBtn.title = "Adicionar nova meta";
      addMetaBtn.dataset.groupId = groupId;
      addMetaBtn.addEventListener('click', showNewMetaModal);
      
      const deleteGroupBtn = document.createElement('button');
      deleteGroupBtn.className = 'delete-group-btn';
      deleteGroupBtn.innerHTML = '<i class="fas fa-trash"></i>';
      deleteGroupBtn.title = "Excluir grupo";
      deleteGroupBtn.dataset.groupId = groupId;
      deleteGroupBtn.addEventListener('click', confirmDeleteGroup);
      
      groupActions.appendChild(addMetaBtn);
      groupActions.appendChild(deleteGroupBtn);
      groupHeader.appendChild(groupActions);
      groupSection.appendChild(groupHeader);
      
      dashboardContent.appendChild(groupSection);
      
      unsavedChanges = true;
      showNotification(`Grupo "${groupName}" criado com sucesso!`, 'success');
    }

    function confirmDeleteGroup(e) {
      const groupId = e.currentTarget.dataset.groupId;
      const groupSection = e.currentTarget.closest('.group-section');
      const groupName = groupSection.querySelector('.group-header').textContent.trim();
      
      showConfirmation(
        `Excluir Grupo "${groupName}"`,
        `Deseja realmente excluir este grupo?`,
        (confirmed) => {
          if (confirmed) {
            // Remover da lista de grupos personalizados
            customGroups = customGroups.filter(group => group.id !== groupId);
            
            // Remover do parsedDoc
            const groupElement = parsedDoc.getElementById(groupId);
            if (groupElement) groupElement.remove();
            
            parsedDoc.querySelectorAll('#tela-inicial .quadrante').forEach(button => {
              if (button.getAttribute('onclick')?.includes(groupId)) {
                button.closest('.button-container').remove();
              }
            });
            
            // Remover do dashboard
            groupSection.remove();
            
            colorCache.delete(groupId);
            unsavedChanges = true;
            showNotification(`Grupo "${groupName}" excluído com sucesso!`, 'success');
          }
        }
      );
    }

    function mapOriginalActivities() {
      originalActivities.clear();
      customGroups = [];
      colorCache.clear();
      
      const allGroups = {};
      const telaInicial = parsedDoc.getElementById('tela-inicial');
      if (!telaInicial) return allGroups;
      
      telaInicial.querySelectorAll('.quadrante').forEach(button => {
        const onclick = button.getAttribute('onclick');
        if (!onclick) return;
        
        const match = onclick.match(/mostrarSubTela\('([^']+)'\)/);
        if (!match) return;
        
        const groupId = match[1];
        if (!groupId || allGroups[groupId]) return;
        
        const groupElement = parsedDoc.getElementById(groupId);
        if (!groupElement) return;
        
        const groupName = groupElement.querySelector('.titulo')?.textContent.trim() || groupId;
        const groupColor = getGroupColor(groupId);
        
        const isCustom = groupId.startsWith('custom-');
        allGroups[groupId] = { name: groupName, color: groupColor, isCustom: isCustom };
        
        if (isCustom) {
          customGroups.push({ id: groupId, name: groupName, color: groupColor });
        }
      });
      
      Object.keys(allGroups).forEach(groupId => {
        const groupElement = parsedDoc.getElementById(groupId);
        if (!groupElement) return;
        
        const groupColor = allGroups[groupId].color;
        
        groupElement.querySelectorAll('.button-container').forEach(container => {
          const button = container.querySelector('.quadrante');
          if (!button) return;
          
          button.style.backgroundColor = groupColor;
          
          const titleElement = container.querySelector('.titulo');
          if (!titleElement) return;
          
          const title = titleElement.textContent.trim();
          if (!title) return;
          
          let meta = container.dataset.meta;
          if (!meta) {
            meta = title.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '');
            container.dataset.meta = meta;
          }
          
          let postIt = container.querySelector('.post-it, [data-meta-comment]');
          if (!postIt && container.nextElementSibling?.classList.contains('post-it')) {
            postIt = container.nextElementSibling;
          }
          
          let objective = '';
          let comment = '';

          if (postIt) {
            objective = postIt.querySelector('p')?.textContent.trim() || '';
            const commentElement = postIt.querySelector('.comentario');
            if (commentElement) {
                comment = commentElement.textContent.replace('Comentário:', '').trim();
            }
          }
          
          originalActivities.set(meta, {
            element: container,
            button: button,
            title: title,
            groupId: groupId,
            objective: objective,
            comment: comment,
            postIt: postIt || null,
            color: groupColor,
            isCurrent: true // Por padrão, considerar que todos os itens são atuais
          });
        });
      });
      
      return allGroups;
    }

    // Função para sincronizar as fotos do dashboard com o parsedDoc
    function sincronizarFotosComParsedDoc() {
      // Percorrer todos os passos no dashboard
      document.querySelectorAll('#dashboard-content .passo').forEach(dashPasso => {
        const stepId = dashPasso.dataset.stepId;
        // Encontrar o mesmo passo no parsedDoc
        const docPasso = parsedDoc.querySelector(`.passo[data-step-id="${stepId}"]`);
        
        if (docPasso) {
          // Verificar se o docPasso tem o botão "Adicionar Foto"
          if (!docPasso.querySelector('.add-image-btn')) {
            const addImageBtn = parsedDoc.createElement('button');
            addImageBtn.className = 'add-image-btn';
            addImageBtn.innerHTML = '<i class="fas fa-camera"></i> ';
            addImageBtn.dataset.stepId = stepId;
            docPasso.appendChild(addImageBtn);
          }
          
          // Obter as miniaturas do dashboard
          const dashThumbs = dashPasso.querySelector('.step-thumbnails');
          
          if (dashThumbs) {
            // Criar ou localizar o container de thumbnails no parsedDoc
            let docThumbs = docPasso.querySelector('.step-thumbnails');
            if (!docThumbs) {
              docThumbs = parsedDoc.createElement('div');
              docThumbs.className = 'step-thumbnails';
              // Inserir antes do botão de adicionar foto, se existir
              const addImageBtn = docPasso.querySelector('.add-image-btn');
              if (addImageBtn) {
                docPasso.insertBefore(docThumbs, addImageBtn);
              } else {
                docPasso.appendChild(docThumbs);
              }
            } else {
              docThumbs.innerHTML = ''; // Limpar container existente
            }
            
            // Copiar todas as miniaturas do dashboard para o parsedDoc
            Array.from(dashThumbs.children).forEach((thumb, index) => {
              const img = thumb.querySelector('img');
              if (img) {
                const imageUrl = img.src;
                const caption = img.dataset.caption || '';
                
                const docThumbContainer = parsedDoc.createElement('div');
                docThumbContainer.className = 'thumbnail-container';
                docThumbContainer.dataset.index = index;
                
                const docImg = parsedDoc.createElement('img');
                docImg.className = 'step-thumbnail';
                docImg.src = imageUrl;
                docImg.alt = caption;
                docImg.dataset.caption = caption;
                
                const docCaption = parsedDoc.createElement('div');
                docCaption.className = 'thumbnail-caption';
                docCaption.textContent = caption;
                
                docThumbContainer.appendChild(docImg);
                docThumbContainer.appendChild(docCaption);
                docThumbs.appendChild(docThumbContainer);
              }
            });
          }
        }
      });
      
      // Também precisamos garantir que os passos do parsedDoc que não estão no dashboard mantenham suas imagens
      parsedDoc.querySelectorAll('.passo').forEach(docPasso => {
        if (!docPasso.querySelector('.add-image-btn')) {
          const stepId = docPasso.dataset.stepId;
          
          const addImageBtn = parsedDoc.createElement('button');
          addImageBtn.className = 'add-image-btn';
          addImageBtn.innerHTML = '<i class="fas fa-camera"></i>';
          addImageBtn.dataset.stepId = stepId;
          docPasso.appendChild(addImageBtn);
        }
      });
    }

    function handleMetaDeletion(e) {
      const metaButton = e.target.closest('.meta-and-steps').querySelector('.meta-button');
      const metaName = metaButton.textContent.trim();
      const groupSection = e.target.closest('.group-section');
      const groupId = groupSection.dataset.group;
      const groupName = groupSection.querySelector('.group-header').textContent.trim();
      
      showConfirmation(
        `Excluir Meta "${metaName}"`,
        `Deseja realmente excluir esta meta?`,
        (confirmed) => {
          if (confirmed) {
            // Encontrar a meta no originalActivities e excluir
            for (const [meta, activity] of originalActivities.entries()) {
              if (activity.title === metaName && activity.groupId === groupId) {
                originalActivities.delete(meta);
                
                // Remover do parsedDoc
                const container = activity.element;
                if (container) container.remove();
                
                // Remover do dashboard
                const metaContainer = e.target.closest('.meta-and-steps');
                if (metaContainer) metaContainer.remove();
                
                unsavedChanges = true;
                showNotification(`Meta "${metaName}" excluída com sucesso!`, 'success');
                break;
              }
            }
          }
        }
      );
    }

    function enableEditingForElement(e) {
      const element = e.target;
      
      // Ignorar se já está em modo de edição ou é um elemento de ação
      if (element.isContentEditable || 
          element.classList.contains('add-meta-btn') || 
          element.classList.contains('delete-group-btn') || 
          element.classList.contains('delete-step-btn') || 
          element.classList.contains('add-step-btn') || 
          element.classList.contains('add-image-btn')) {
        return;
      }
      
      // Habilitar edição
      element.contentEditable = "true";
      element.focus();
      
      // Selecionar todo o texto
      const selection = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(element);
      selection.removeAllRanges();
      selection.addRange(range);
      
      // Salvar quando perder o foco
      const saveEdit = () => {
        element.contentEditable = "false";
        const newValue = element.textContent.trim();
        
        if (newValue) {
          // Se for um título de grupo
          if (element.classList.contains('group-header')) {
            const groupSection = element.closest('.group-section');
            const groupId = groupSection.dataset.group;
            
            // Atualizar no parsedDoc
            const groupElement = parsedDoc.getElementById(groupId);
            if (groupElement && groupElement.querySelector('.titulo')) {
              groupElement.querySelector('.titulo').textContent = newValue;
            }
            
            // Atualizar no telaInicial
            const telaInicial = parsedDoc.getElementById('tela-inicial');
            if (telaInicial) {
              telaInicial.querySelectorAll('.quadrante').forEach(button => {
                if (button.getAttribute('onclick')?.includes(groupId)) {
                  const titleDiv = button.querySelector('.titulo');
                  if (titleDiv) titleDiv.textContent = newValue;
                }
              });
            }
            
            // Atualizar em customGroups se for um grupo personalizado
            if (groupId.startsWith('custom-')) {
              const groupIndex = customGroups.findIndex(g => g.id === groupId);
              if (groupIndex !== -1) {
                customGroups[groupIndex].name = newValue;
              }
            }
          }
          // Se for um botão de meta
          else if (element.classList.contains('meta-button')) {
            const metaContainer = element.closest('.meta-and-steps');
            const groupSection = metaContainer.closest('.group-section');
            const groupId = groupSection.dataset.group;
            
            // Encontrar e atualizar na lista de originalActivities
            for (const [meta, activity] of originalActivities.entries()) {
              if (activity.groupId === groupId && activity.title.toLowerCase() === element.getAttribute('data-original-text').toLowerCase()) {
                // Atualizar o elemento no parsedDoc
                const titleElement = activity.element.querySelector('.titulo');
                if (titleElement) titleElement.textContent = newValue;
                
                // Atualizar em originalActivities
                activity.title = newValue;
                
                break;
              }
            }
          }
          // Se for um conteúdo de passo
          else if (element.closest('.passo')) {
            const passo = element.closest('.passo');
            const stepId = passo.dataset.stepId;
            const isTitleElement = element.tagName === 'H4';
            const isCommentElement = element.classList.contains('comentario');
            
            // Se não for título nem comentário, é o conteúdo principal
            if (!isTitleElement && !isCommentElement) {
              // Encontrar o passo no parsedDoc
              const docPasso = parsedDoc.querySelector(`.passo[data-step-id="${stepId}"]`);
              if (docPasso) {
                const contentP = docPasso.querySelector('p');
                if (contentP) contentP.innerHTML = `${newValue}`;
              }
            } else if (isCommentElement) {
              // É um comentário
              const docPasso = parsedDoc.querySelector(`.passo[data-step-id="${stepId}"]`);
              if (docPasso) {
                let commentDiv = docPasso.querySelector('.comentario');
                if (commentDiv) {
                  commentDiv.textContent = newValue;
                } else if (newValue) {
                  // Criar div de comentário se não existir
                  commentDiv = document.createElement('div');
                  commentDiv.className = 'comentario';
                  commentDiv.textContent = newValue;
                  docPasso.appendChild(commentDiv);
                }
              }
            }
            // Não permitimos editar o título do passo (H4) pois ele é gerenciado automaticamente
          }
          
          unsavedChanges = true;
        }
        
        element.removeEventListener('blur', saveEdit);
        element.removeEventListener('keydown', handleKeyDown);
      };
      
      const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          element.blur();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          element.textContent = element.getAttribute('data-original-text') || element.textContent;
          element.blur();
        }
      };
      
      // Guardar o texto original para caso de cancelamento
      element.setAttribute('data-original-text', element.textContent.trim());
      
      element.addEventListener('blur', saveEdit);
      element.addEventListener('keydown', handleKeyDown);
    }

    function showStepStatusModal(metaContainer) {
      return new Promise((resolve) => {
        // Verificar se existem passos anteriores
        const existingSteps = metaContainer.querySelectorAll('.passo');
        if (existingSteps.length === 0) {
          // Se não há passos anteriores, não precisamos perguntar
          resolve(null);
          return;
        }
        
        // Armazenar referência ao último passo
        previousStepElement = existingSteps[existingSteps.length - 1];
        
        // Mostrar modal de status
        const modal = document.getElementById('step-status-modal');
        modal.style.display = 'block';
        
        // Configurar listeners
        document.getElementById('step-status-yes').onclick = () => {
          modal.style.display = 'none';
          resolve('s');
        };
        
        document.getElementById('step-status-no').onclick = () => {
          modal.style.display = 'none';
          resolve('n');
        };
      });
    }

    function showNewStepModal(e) {
      const metaContainer = e.currentTarget.closest('.meta-and-steps');
      const metaButton = metaContainer.querySelector('.meta-button');
      const metaName = metaButton.textContent.trim();
      const groupSection = e.currentTarget.closest('.group-section');
      const groupId = groupSection.dataset.group;
      
      // Primeiro, perguntar sobre o status do passo anterior
      showStepStatusModal(metaContainer).then(status => {
        // Se temos um passo anterior e um status
        if (previousStepElement && status) {
          // Atualizar o estilo do passo anterior com base no status
          if (status === 's') {
            previousStepElement.style.background = 'white';
          } else {
            previousStepElement.style.background = '#FFCCCC';
          }
          
          // Atualizar o mesmo passo no parsedDoc
          const stepId = previousStepElement.dataset.stepId;
          const docPasso = parsedDoc.querySelector(`.passo[data-step-id="${stepId}"]`);
          if (docPasso) {
            if (status === 's') {
              docPasso.style.background = 'white';
            } else {
              docPasso.style.background = '#FFCCCC';
            }
          }
          
          // Remover a classe de passo atual do passo anterior
          previousStepElement.classList.remove('current-step');
          if (docPasso) docPasso.classList.remove('current-step');
          
          // Atualizar a numeração dos passos
          renumberSteps(metaContainer);
        }
        
        // Agora mostrar o modal de novo passo
        const modal = document.getElementById('new-step-modal');
        const activityField = document.getElementById('new-step-activity');
        const commentField = document.getElementById('new-step-comment');
        
        // Limpar campos
        activityField.value = '';
        commentField.value = '';
        
        // Configurar contexto atual
        currentStepContext = {
          metaName: metaName,
          groupId: groupId,
          metaContainer: metaContainer
        };
        
        // Mostrar modal
        modal.style.display = 'block';
      });
    }
    
    function saveNewStep() {
      const modal = document.getElementById('new-step-modal');
      const activityField = document.getElementById('new-step-activity');
      const commentField = document.getElementById('new-step-comment');
      
      const activity = activityField.value.trim();
      const comment = commentField.value.trim();
      
      if (!activity) {
        showNotification('Por favor, preencha o conteúdo do passo.', 'error');
        return;
      }
      
      const { metaName, groupId, metaContainer } = currentStepContext;
      
      // Criar novo passo
      const newStep = document.createElement('div');
      newStep.className = 'passo current-step'; // Marcamos como atual
      const newStepId = generateUniqueId();
      newStep.dataset.stepId = newStepId;
      
      // Contar passos existentes para definir o número
      const passos = metaContainer.querySelectorAll('.passo');
      const num = passos.length + 1;
      
      // Definir conteúdo do passo
      newStep.innerHTML = `
        <h4>Passo ${num} (Atual)</h4>
        <p>${activity}</p>
        ${comment ? `<div class="comentario">${comment}</div>` : ''}
        <div class="step-thumbnails"></div>
        <button class="delete-step-btn" title="Excluir passo">×</button>
        <button class="add-image-btn" data-step-id="${newStepId}" title="Adicionar imagem">
          <i class="fas fa-camera"></i>
        </button>
      `;
      
      // Adicionar ao container de meta
      metaContainer.appendChild(newStep);
      
      // Adicionar event listeners
      const deleteBtn = newStep.querySelector('.delete-step-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', confirmDeleteStep);
      }
      
      const addImageBtn = newStep.querySelector('.add-image-btn');
      if (addImageBtn) {
        addImageBtn.addEventListener('click', () => showImageModal(newStepId));
      }
      
      // Permitir edição por duplo clique no texto
      const stepContent = newStep.querySelector('p');
      if (stepContent) {
        stepContent.addEventListener('dblclick', enableEditingForElement);
      }
      
      const stepComment = newStep.querySelector('.comentario');
      if (stepComment) {
        stepComment.addEventListener('dblclick', enableEditingForElement);
      }
      
      // Adicionar ao parsedDoc também
      let dashboard = parsedDoc.getElementById('dashboard');
      if (!dashboard) {
        dashboard = parsedDoc.createElement('div');
        dashboard.id = 'dashboard';
        parsedDoc.body.appendChild(dashboard);
      }
      
      let groupSection = Array.from(dashboard.querySelectorAll('.group-section')).find(
        gs => gs.dataset.group === groupId
      );
      
      if (!groupSection) {
        groupSection = document.createElement('div');
        groupSection.className = 'group-section';
        groupSection.dataset.group = groupId;
        
        const groupHeader = document.createElement('div');
        groupHeader.className = 'group-header';
        groupHeader.style.backgroundColor = getGroupColor(groupId);
        
        const groupName = parsedDoc.getElementById(groupId)?.querySelector('.titulo')?.textContent || '';
        groupHeader.textContent = groupName;
        
        groupSection.appendChild(groupHeader);
        dashboard.appendChild(groupSection);
      }
      
      let metaCont = Array.from(groupSection.querySelectorAll('.meta-and-steps')).find(
        m => m.querySelector('.meta-button')?.textContent.trim() === metaName
      );
      
      if (!metaCont) {
        metaCont = document.createElement('div');
        metaCont.className = 'meta-and-steps';
        
        const metaBtn = document.createElement('div');
        metaBtn.className = 'meta-button';
        metaBtn.style.backgroundColor = getGroupColor(groupId);
        metaBtn.textContent = metaName;
        
        metaCont.appendChild(metaBtn);
        groupSection.appendChild(metaCont);
      }
      
      const docStep = newStep.cloneNode(true);
      metaCont.appendChild(docStep);
      
      // Atualizar também nos originalActivities para salvar no HTML
      for (const [meta, activity] of originalActivities.entries()) {
        if (activity.title === metaName && activity.groupId === groupId) {
          if (activity.postIt) {
            activity.objective = activity.postIt.querySelector('p').textContent = activity;
            
            let commentElement = activity.postIt.querySelector('.comentario');
            if (comment) {
              if (commentElement) {
                commentElement.textContent = comment;
              } else {
                commentElement = document.createElement('div');
                commentElement.className = 'comentario';
                commentElement.textContent = comment;
                activity.postIt.appendChild(commentElement);
              }
              activity.comment = comment;
            }
          } else if (activity.element) {
            const postIt = document.createElement('div');
            postIt.className = 'post-it';
            postIt.innerHTML = `<p>${activity}</p>`;
            
            if (comment) {
              postIt.innerHTML += `<div class="comentario">${comment}</div>`;
              activity.comment = comment;
            }
            
            activity.element.appendChild(postIt);
            activity.postIt = postIt;
            activity.objective = activity;
          }
          break;
        }
      }
      
      unsavedChanges = true;
      
      // Adicionar último passo do meta container com botão de adicionar
      addStepButton(metaContainer);
      
      // Fechar modal
      modal.style.display = 'none';
      currentStepContext = null;
      
      showNotification('Novo passo adicionado com sucesso!', 'success');
    }
    
    function showNewMetaModal(e) {
      const groupId = e.currentTarget.dataset.groupId;
      const groupSection = e.currentTarget.closest('.group-section');
      const groupName = groupSection.querySelector('.group-header').textContent.trim();
      
      const modal = document.getElementById('new-meta-modal');
      const nameField = document.getElementById('new-meta-name');
      const activityField = document.getElementById('new-meta-activity');
      const commentField = document.getElementById('new-meta-comment');
      
      // Limpar campos
      nameField.value = '';
      activityField.value = '';
      commentField.value = '';
      
      // Configurar contexto atual
      currentMetaContext = {
        groupId: groupId,
        groupName: groupName,
        groupSection: groupSection
      };
      
      // Mostrar modal
      modal.style.display = 'block';
    }
    
    function saveNewMeta() {
      const modal = document.getElementById('new-meta-modal');
      const nameField = document.getElementById('new-meta-name');
      const activityField = document.getElementById('new-meta-activity');
      const commentField = document.getElementById('new-meta-comment');
      
      const name = nameField.value.trim();
      const activity = activityField.value.trim();
      const comment = commentField.value.trim();
      
      if (!name) {
        showNotification('Por favor, forneça um nome para a meta.', 'error');
        return;
      }
      
      const { groupId, groupName, groupSection } = currentMetaContext;
      const groupColor = getGroupColor(groupId);
      
      // Verificar se a meta já existe
      const metaExists = Array.from(groupSection.querySelectorAll('.meta-and-steps')).some(
        m => m.querySelector('.meta-button')?.textContent.trim().toLowerCase() === name.toLowerCase()
      );
      
      
      if (metaExists) {
        showNotification(`A meta "${name}" já existe neste grupo.`, 'error');
        return;
      }
      
      // Criar nova meta no dashboard
      const metaContainer = document.createElement('div');
      metaContainer.className = 'meta-and-steps';
      
      const metaButton = document.createElement('div');
      metaButton.className = 'meta-button';
      metaButton.style.backgroundColor = groupColor;
      metaButton.textContent = name;
      metaButton.addEventListener('dblclick', enableEditingForElement);
      
      metaContainer.appendChild(metaButton);
      groupSection.appendChild(metaContainer);
      
      // Criar elemento no parsedDoc
      const normalizedName = name.replace(/\W+/g, '_').toLowerCase();
      
      const group = parsedDoc.getElementById(groupId);
      if (!group) {
        showNotification(`Grupo com ID "${groupId}" não encontrado!`, 'error');
        return;
      }
      
      const container = group.querySelector('.container') || group;
      const btnCont = document.createElement('div');
      btnCont.className = 'button-container';
      btnCont.dataset.meta = normalizedName;
      
      const button = document.createElement('div');
      button.className = 'quadrante';
      button.style.backgroundColor = groupColor;
      button.innerHTML = `<div class="titulo">${name}</div>`;
      btnCont.appendChild(button);
      
      if (activity || comment) {
        const postIt = document.createElement('div');
        postIt.className = 'post-it';
        postIt.innerHTML = `<p>${activity}</p>`;
        if (comment) postIt.innerHTML += `<div class="comentario">${comment}</div>`;
        btnCont.appendChild(postIt);
      }
      
      container.appendChild(btnCont);
      
      // Adicionar à originalActivities
      originalActivities.set(normalizedName, {
        element: btnCont,
        button: button,
        title: name,
        groupId: groupId,
        objective: activity,
        comment: comment,
        postIt: btnCont.querySelector('.post-it') || null,
        color: groupColor,
        isCurrent: true
      });
      
      // Se tiver atividade ou comentário, criar um passo atual
      if (activity || comment) {
        const newStep = document.createElement('div');
        newStep.className = 'passo current-step'; // Marcamos como atual
        const newStepId = generateUniqueId();
        newStep.dataset.stepId = newStepId;
        
        newStep.innerHTML = `
          <h4>Passo 1 (Atual)</h4>
          <p>${activity}</p>
          ${comment ? `<div class="comentario">${comment}</div>` : ''}
          <div class="step-thumbnails"></div>
          <button class="delete-step-btn" title="Excluir passo">×</button>
          <button class="add-image-btn" data-step-id="${newStepId}" title="Adicionar imagem">
            <i class="fas fa-camera"></i>
          </button>
        `;
        
        metaContainer.appendChild(newStep);
        
        // Adicionar event listeners
        const deleteBtn = newStep.querySelector('.delete-step-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', confirmDeleteStep);
        }
        
        const addImageBtn = newStep.querySelector('.add-image-btn');
        if (addImageBtn) {
          addImageBtn.addEventListener('click', () => showImageModal(newStepId));
        }
        
        // Permitir edição por duplo clique
        const stepContent = newStep.querySelector('p');
        if (stepContent) {
          stepContent.addEventListener('dblclick', enableEditingForElement);
        }
        
        const stepComment = newStep.querySelector('.comentario');
        if (stepComment) {
          stepComment.addEventListener('dblclick', enableEditingForElement);
        }
      }
      
      // Adicionar botão de adicionar passo
      addStepButton(metaContainer);
      
      unsavedChanges = true;
      
      // Fechar modal
      modal.style.display = 'none';
      currentMetaContext = null;
      
      showNotification('Nova meta adicionada com sucesso!', 'success');
    }
    
    function addStepButton(metaContainer) {
      // Remover botões existentes de adicionar passo
      metaContainer.querySelectorAll('.add-step-btn').forEach(btn => btn.remove());
      
      // Adicionar botão ao último passo ou ao container da meta
      const passos = metaContainer.querySelectorAll('.passo');
      
      if (passos.length > 0) {
        const lastStep = passos[passos.length - 1];
        const addBtn = document.createElement('button');
        addBtn.className = 'add-step-btn';
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Novo Passo';
        addBtn.title = 'Adicionar novo passo';
        addBtn.addEventListener('click', showNewStepModal);
        
        lastStep.appendChild(addBtn);
      } else {
        // Se não há passos, adicionar o botão diretamente ao container da meta
        const addBtn = document.createElement('button');
        addBtn.className = 'add-step-btn';
        addBtn.style.marginLeft = '15px';
        addBtn.style.width = '170px';
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Novo Passo';
        addBtn.title = 'Adicionar novo passo';
        addBtn.addEventListener('click', showNewStepModal);
        
        metaContainer.appendChild(addBtn);
      }
    }

    function confirmDeleteStep(e) {
      const step = e.target.closest('.passo');
      const stepId = step.dataset.stepId;
      const stepNumber = step.querySelector('h4').textContent.replace(/[^\d]/g, '');
      
      showConfirmation(
        `Excluir Passo ${stepNumber}`,
        `Deseja realmente excluir este passo?`,
        (confirmed) => {
          if (confirmed) {
            const metaContainer = step.closest('.meta-and-steps');
            
            // Remover do parsedDoc
            const realPasso = parsedDoc.querySelector(`.passo[data-step-id="${stepId}"]`);
            if (realPasso) realPasso.remove();
            
            // Remover do dashboard
            step.remove();
            
            // Renumerar os passos restantes
            renumberSteps(metaContainer);
            
            // Reposicionar o botão de adicionar passo
            addStepButton(metaContainer);
            
            unsavedChanges = true;
            showNotification(`Passo ${stepNumber} excluído com sucesso!`, 'success');
          }
        }
      );
    }

    function renumberSteps(container) {
      const steps = container.querySelectorAll('.passo');
      steps.forEach((step, index) => {
        const number = index + 1;
        const h4 = step.querySelector('h4');
        if (h4) {
          const isCurrent = step.classList.contains('current-step');
          h4.textContent = `Passo ${number}${isCurrent ? ' (Atual)' : ''}`;
        }
      });
    }

    function sanitizeContent() {
      // Esta função será chamada antes de salvar para garantir que o conteúdo está limpo
      document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.contentEditable = "false";
      });
    }

function saveAll() {
  sanitizeContent();
  
  // Atualizar data e usuário
  const currentDate = "2025-08-04 11:55:21";
  const currentUser = "adrianodamato20152015";
  
  // Criar ou limpar o dashboard no parsedDoc se já existir
  let dashboard = parsedDoc.getElementById('dashboard');
  if (!dashboard) {
    dashboard = parsedDoc.createElement('div');
    dashboard.id = 'dashboard';
    parsedDoc.body.appendChild(dashboard);
  } else {
    // Limpar o conteúdo existente para evitar duplicações
    dashboard.innerHTML = '';
  }
  
  // Adicionar botão "Voltar" ao dashboard
  const voltarBtn = document.createElement('button');
  voltarBtn.className = 'action-button';
  voltarBtn.textContent = 'Voltar';
  voltarBtn.setAttribute('onclick', 'voltarTela(\'tela-inicial\')');
  voltarBtn.style.float = 'right';
  voltarBtn.style.margin = '10px';
  dashboard.appendChild(voltarBtn);
  
  // Adicionar título ao dashboard
  const dashTitle = document.createElement('h2');
  dashTitle.textContent = 'Dashboard de Monitoramento';
  dashTitle.style.textAlign = 'center';
  dashTitle.style.marginBottom = '25px';
  dashboard.appendChild(dashTitle);
  
  // Garantir que todos os dados atualizados no dashboard são refletidos no parsedDoc
  document.querySelectorAll('#dashboard-content .group-section').forEach(groupSection => {
    const groupId = groupSection.dataset.group;
    const groupHeader = groupSection.querySelector('.group-header');
    const groupName = groupHeader.textContent.trim();
    
    // Atualizar o título do grupo no parsedDoc se necessário
    const groupElement = parsedDoc.getElementById(groupId);
    if (groupElement && groupElement.querySelector('.titulo')) {
      const currentName = groupElement.querySelector('.titulo').textContent.trim();
      if (currentName !== groupName) {
        groupElement.querySelector('.titulo').textContent = groupName;
        
        // Também atualizar o botão no tela-inicial
        const telaInicial = parsedDoc.getElementById('tela-inicial');
        if (telaInicial) {
          telaInicial.querySelectorAll('.quadrante').forEach(button => {
            if (button.getAttribute('onclick')?.includes(groupId)) {
              const titleDiv = button.querySelector('.titulo');
              if (titleDiv) titleDiv.textContent = groupName;
            }
          });
        }
      }
    }
    
    // Criar ou atualizar seção do grupo no dashboard do parsedDoc
    let docGroupSection = dashboard.querySelector(`.group-section[data-group="${groupId}"]`);
    if (!docGroupSection) {
      docGroupSection = document.createElement('div');
      docGroupSection.className = 'group-section';
      docGroupSection.dataset.group = groupId;
      
      const docHeader = document.createElement('div');
      docHeader.className = 'group-header';
      docHeader.style.backgroundColor = getGroupColor(groupId);
      docHeader.textContent = groupName;
      
      docGroupSection.appendChild(docHeader);
      dashboard.appendChild(docGroupSection);
    } else {
      // Limpar os meta-and-steps existentes para evitar duplicação
      docGroupSection.querySelectorAll('.meta-and-steps').forEach(metaCont => {
        metaCont.remove();
      });
    }
    
    // Processar cada meta do grupo
    groupSection.querySelectorAll('.meta-and-steps').forEach(metaContainer => {
      const metaButton = metaContainer.querySelector('.meta-button');
      if (!metaButton) return;
      
      const metaName = metaButton.textContent.trim();
      const normalizedName = metaName.toLowerCase().replace(/\W+/g, '_');
      
      // Criar meta no dashboard do parsedDoc
      const docMetaContainer = document.createElement('div');
      docMetaContainer.className = 'meta-and-steps';
      
      const docMetaBtn = document.createElement('div');
      docMetaBtn.className = 'meta-button';
      docMetaBtn.style.backgroundColor = getGroupColor(groupId);
      docMetaBtn.textContent = metaName;
      
      docMetaContainer.appendChild(docMetaBtn);
      docGroupSection.appendChild(docMetaContainer);
      
      // Encontrar a meta correspondente em originalActivities
      let found = false;
      for (const [meta, activity] of originalActivities.entries()) {
        if (activity.groupId === groupId && activity.title.toLowerCase() === metaName.toLowerCase()) {
          found = true;
          
          // Atualizar o título se necessário
          const titleElement = activity.element.querySelector('.titulo');
          if (titleElement && titleElement.textContent.trim() !== metaName) {
            titleElement.textContent = metaName;
          }
          
          // Processar passos
          const passos = metaContainer.querySelectorAll('.passo');
          if (passos.length > 0) {
            // Copiar todos os passos para o docMetaContainer (sem botões de adicionar ou excluir)
            passos.forEach(passo => {
              const passoClone = passo.cloneNode(true);
              
              // Remover botões de "Novo Passo" do HTML final
              const addStepBtns = passoClone.querySelectorAll('.add-step-btn');
              addStepBtns.forEach(btn => btn.remove());
              
              // Remover botões de exclusão "×" do HTML final
              const deleteStepBtns = passoClone.querySelectorAll('.delete-step-btn');
              deleteStepBtns.forEach(btn => btn.remove());
              
              docMetaContainer.appendChild(passoClone);
            });
            
            // Pegar o último passo (atual) para obter objetivo e comentário atualizados
            const lastStep = passos[passos.length - 1];
            const lastContent = lastStep.querySelector('p')?.textContent;
            let objective = '';
            if (lastContent) {
              objective = lastContent.trim();
            }
            
            const lastComment = lastStep.querySelector('.comentario')?.textContent || '';
            
            // Atualizar o post-it
            if (objective || lastComment) {
              let postIt = activity.postIt;
              if (!postIt) {
                postIt = document.createElement('div');
                postIt.className = 'post-it';
                activity.element.appendChild(postIt);
                activity.postIt = postIt;
              }
              
              // Atualizar conteúdo do post-it
              if (objective) {
                let p = postIt.querySelector('p');
                if (!p) {
                  p = document.createElement('p');
                  postIt.appendChild(p);
                }
                p.textContent = objective;
              }
              
              if (lastComment) {
                let commentDiv = postIt.querySelector('.comentario');
                if (!commentDiv) {
                  commentDiv = document.createElement('div');
                  commentDiv.className = 'comentario';
                  postIt.appendChild(commentDiv);
                }
                commentDiv.textContent = lastComment;
              } else {
                // Remover div de comentário se existir e estiver vazio
                const commentDiv = postIt.querySelector('.comentario');
                if (commentDiv) commentDiv.remove();
              }
              
              activity.objective = objective;
              activity.comment = lastComment;
            }
          }
          
          break;
        }
      }
      
      // Se não encontrou, adicionar nova meta
      if (!found) {
        // Verificar se há passos
        const passos = metaContainer.querySelectorAll('.passo');
        let objective = '';
        let comment = '';
        
        if (passos.length > 0) {
          const lastStep = passos[passos.length - 1];
          const lastContent = lastStep.querySelector('p')?.textContent;
          if (lastContent) {
            objective = lastContent.trim();
          }
          comment = lastStep.querySelector('.comentario')?.textContent || '';
          
          // Copiar todos os passos para o docMetaContainer (sem botões de adicionar ou excluir)
          passos.forEach(passo => {
            const passoClone = passo.cloneNode(true);
            
            // Remover botões de "Novo Passo" do HTML final
            const addStepBtns = passoClone.querySelectorAll('.add-step-btn');
            addStepBtns.forEach(btn => btn.remove());
            
            // Remover botões de exclusão "×" do HTML final
            const deleteStepBtns = passoClone.querySelectorAll('.delete-step-btn');
            deleteStepBtns.forEach(btn => btn.remove());
            
            docMetaContainer.appendChild(passoClone);
          });
        }
        
        // Criar nova meta no parsedDoc
        const group = parsedDoc.getElementById(groupId);
        if (!group) return;
        
        const container = group.querySelector('.container') || group;
        const btnCont = document.createElement('div');
        btnCont.className = 'button-container';
        btnCont.dataset.meta = normalizedName;
        
        const button = document.createElement('div');
        button.className = 'quadrante';
        button.style.backgroundColor = getGroupColor(groupId);
        button.innerHTML = `<div class="titulo">${metaName}</div>`;
        btnCont.appendChild(button);
        
        if (objective || comment) {
          const postIt = document.createElement('div');
          postIt.className = 'post-it';
          postIt.innerHTML = `<p>${objective}</p>`;
          if (comment) postIt.innerHTML += `<div class="comentario">${comment}</div>`;
          btnCont.appendChild(postIt);
        }
        
        container.appendChild(btnCont);
        
        originalActivities.set(normalizedName, {
          element: btnCont,
          button: button,
          title: metaName,
          groupId: groupId,
          objective: objective,
          comment: comment,
          postIt: btnCont.querySelector('.post-it') || null,
          color: getGroupColor(groupId),
          isCurrent: true
        });
      }
    });
  });
  
  // Remover botões "Novo Passo" soltos (fora de passos) no HTML final
  const soloAddBtns = dashboard.querySelectorAll('.add-step-btn');
  soloAddBtns.forEach(btn => btn.remove());
  
  // Remover botões de exclusão "×" soltos (fora de passos) no HTML final
  const soloDeleteBtns = dashboard.querySelectorAll('.delete-step-btn');
  soloDeleteBtns.forEach(btn => btn.remove());
  
  // Sincronizar fotos com parsedDoc
  sincronizarFotosComParsedDoc();
  
  // Garantir IDs após salvar
  ensureStepIds();
  unsavedChanges = false;
  
  showNotification('Todas as alterações foram salvas!', 'success');
}
    function generateDashboardContent() {
      ensureStepIds(); // Garantir IDs antes de exibir
      const dash = document.getElementById('dashboard-content');
      dash.innerHTML = '';
      
      const allGroups = mapOriginalActivities();
      
      Object.keys(allGroups).forEach(groupId => {
        const group = allGroups[groupId];
        const groupName = group.name;
        const groupColor = group.color;
        
        const groupSection = document.createElement('div');
        groupSection.className = 'group-section';
        groupSection.dataset.group = groupId;
        
        const groupHeader = document.createElement('div');
        groupHeader.className = 'group-header';
        groupHeader.style.backgroundColor = groupColor;
        groupHeader.textContent = groupName;
        groupHeader.addEventListener('dblclick', enableEditingForElement);
        
        const groupActions = document.createElement('div');
        groupActions.className = 'group-actions';
        
        const addMetaBtn = document.createElement('button');
        addMetaBtn.className = 'add-meta-btn';
        addMetaBtn.innerHTML = '<i class="fas fa-plus"></i>';
        addMetaBtn.title = "Adicionar nova meta";
        addMetaBtn.dataset.groupId = groupId;
        addMetaBtn.addEventListener('click', showNewMetaModal);
        
        const deleteGroupBtn = document.createElement('button');
        deleteGroupBtn.className = 'delete-group-btn';
        deleteGroupBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteGroupBtn.title = "Excluir grupo";
        deleteGroupBtn.dataset.groupId = groupId;
        deleteGroupBtn.addEventListener('click', confirmDeleteGroup);
        
        groupActions.appendChild(addMetaBtn);
        groupActions.appendChild(deleteGroupBtn);
        groupHeader.appendChild(groupActions);
        groupSection.appendChild(groupHeader);
        
        // Agrupar atividades por meta
        const metasByName = {};
        originalActivities.forEach((activity, meta) => {
          if (activity.groupId === groupId) {
            const title = activity.title;
            if (!metasByName[title]) {
              metasByName[title] = {
                meta,
                activity,
                steps: []
              };
            }
          }
        });
        
        // Adicionar metas ao grupo
        Object.entries(metasByName).forEach(([title, data]) => {
          const { activity, meta } = data;
          const metaContainer = document.createElement('div');
          metaContainer.className = 'meta-and-steps';
          
          const metaButton = document.createElement('div');
          metaButton.className = 'meta-button';
          metaButton.style.backgroundColor = groupColor;
          metaButton.textContent = title;
          metaButton.addEventListener('dblclick', enableEditingForElement);
          
          metaContainer.appendChild(metaButton);
          
          // BUSCAR PASSOS HISTÓRICOS
          // Buscar em qualquer lugar no documento, não apenas no dashboard
          const metaElements = parsedDoc.querySelectorAll('.meta-and-steps');
          let historicalSteps = [];
          
          metaElements.forEach(metaElement => {
            const metaBtn = metaElement.querySelector('.meta-button');
            if (metaBtn && metaBtn.textContent.trim() === title) {
              const steps = metaElement.querySelectorAll('.passo:not(.current-step)');
              steps.forEach(step => {
                historicalSteps.push(step);
              });
            }
          });
          
          // Adicionar passos históricos
          historicalSteps.forEach((step, index) => {
            const stepClone = step.cloneNode(true);
            const stepId = step.dataset.stepId || generateUniqueId();
            stepClone.dataset.stepId = stepId;
            
            // Remover botões existentes de ação e adicionar novos
            stepClone.querySelectorAll('.delete-step-btn, .add-step-btn, .add-image-btn').forEach(btn => btn.remove());
            
            // Adicionar botão de excluir
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-step-btn';
            deleteBtn.textContent = '×';
            deleteBtn.title = 'Excluir passo';
            deleteBtn.addEventListener('click', confirmDeleteStep);
            stepClone.appendChild(deleteBtn);
            
            // Adicionar botão de imagem
            const addImageBtn = document.createElement('button');
            addImageBtn.className = 'add-image-btn';
            addImageBtn.innerHTML = '<i class="fas fa-camera"></i>';
            addImageBtn.title = 'Adicionar imagem';
            addImageBtn.dataset.stepId = stepId;
            addImageBtn.addEventListener('click', () => showImageModal(stepId));
            stepClone.appendChild(addImageBtn);
            
            // Adicionar event listeners para edição
            const content = stepClone.querySelector('p');
            if (content) content.addEventListener('dblclick', enableEditingForElement);
            
            const comment = stepClone.querySelector('.comentario');
            if (comment) comment.addEventListener('dblclick', enableEditingForElement);
            
            metaContainer.appendChild(stepClone);
          });
          
          // Verificar se tem atividade e comentário para criar passo atual
          if (activity.objective || activity.comment) {
            const passoDiv = document.createElement('div');
            passoDiv.className = 'passo current-step'; // Marcamos como atual
            const stepId = generateUniqueId();
            passoDiv.dataset.stepId = stepId;
            
            const totalSteps = historicalSteps.length + 1;
            
            passoDiv.innerHTML = `
              <h4>Passo ${totalSteps} (Atual)</h4>
              <p>${activity.objective}</p>
              ${activity.comment ? `<div class="comentario">${activity.comment}</div>` : ''}
              <div class="step-thumbnails"></div>
              <button class="delete-step-btn" title="Excluir passo">×</button>
              <button class="add-image-btn" data-step-id="${stepId}" title="Adicionar imagem">
                <i class="fas fa-camera"></i>
              </button>
            `;
            
            metaContainer.appendChild(passoDiv);
            
            // Adicionar event listeners
            passoDiv.querySelector('.delete-step-btn').addEventListener('click', confirmDeleteStep);
            passoDiv.querySelector('.add-image-btn').addEventListener('click', () => showImageModal(stepId));
            
            // Adicionar event listeners para edição
            const content = passoDiv.querySelector('p');
            if (content) content.addEventListener('dblclick', enableEditingForElement);
            
            const comment = passoDiv.querySelector('.comentario');
            if (comment) comment.addEventListener('dblclick', enableEditingForElement);
            
            // Adicionar ao parsedDoc se não existir
            let docStep = parsedDoc.querySelector(`.passo[data-step-id="${stepId}"]`);
            if (!docStep) {
              docStep = passoDiv.cloneNode(true);
              
              // Encontrar ou criar container no parsedDoc
              let dashboard = parsedDoc.getElementById('dashboard');
              if (!dashboard) {
                dashboard = parsedDoc.createElement('div');
                dashboard.id = 'dashboard';
                parsedDoc.body.appendChild(dashboard);
              }
              
              let docGroupSection = dashboard.querySelector(`.group-section[data-group="${groupId}"]`);
              if (!docGroupSection) {
                docGroupSection = document.createElement('div');
                docGroupSection.className = 'group-section';
                docGroupSection.dataset.group = groupId;
                
                const docHeader = document.createElement('div');
                docHeader.className = 'group-header';
                docHeader.style.backgroundColor = groupColor;
                docHeader.textContent = groupName;
                
                docGroupSection.appendChild(docHeader);
                dashboard.appendChild(docGroupSection);
              }
              
              let docMetaContainer = Array.from(docGroupSection.querySelectorAll('.meta-and-steps')).find(
                m => m.querySelector('.meta-button')?.textContent.trim() === title
              );
              
              if (!docMetaContainer) {
                docMetaContainer = document.createElement('div');
                docMetaContainer.className = 'meta-and-steps';
                
                const docMetaBtn = document.createElement('div');
                docMetaBtn.className = 'meta-button';
                docMetaBtn.style.backgroundColor = groupColor;
                docMetaBtn.textContent = title;
                
                docMetaContainer.appendChild(docMetaBtn);
                docGroupSection.appendChild(docMetaContainer);
              }
              
              docMetaContainer.appendChild(docStep);
            }
          }
          
          // Adicionar botão de novo passo
          addStepButton(metaContainer);
          
          groupSection.appendChild(metaContainer);
        });
        
        dash.appendChild(groupSection);
      });
      
      // Renumerar todos os passos
      document.querySelectorAll('.meta-and-steps').forEach(metaContainer => {
        renumberSteps(metaContainer);
      });
    }

    function redimensionarImagensNoHtml() {
      // Primeiro, adicionamos um estilo global para o comportamento de ampliação
      let modalStyle = parsedDoc.getElementById('modal-image-style');
      if (!modalStyle) {
        modalStyle = parsedDoc.createElement('style');
        modalStyle.id = 'modal-image-style';
        parsedDoc.head.appendChild(modalStyle);
        modalStyle.textContent = `
          /* Estilo modal para ampliação de imagens */
          .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
          }
          .modal-content {
            margin: 5% auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
          }
          .modal-caption {
            color: white;
            padding: 10px;
            text-align: center;
            width: 80%;
            margin: 0 auto;
            font-size: 16px;
          }
          .close-modal {
            color: white;
            position: absolute;
            top: 15px;
            right: 35px;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
          }

          /* Estilo específico para o dashboard */
          .step-thumbnails {
            margin-top: 10px;
            text-align: center;
          }
          .thumbnail-container {
            display: inline-block;
            margin: 2px;
            position: relative;
            cursor: pointer;
          }
          .step-thumbnail {
            max-width: 150px;
            max-height: 150px;
            border-radius: 3px;
          }
          .thumbnail-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 9px;
            padding: 3px;
            text-align: center;
          }
          .add-image-btn {
            background-color: #f0f0f0;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            margin: 10px auto 0;
            display: block;
            font-size: 12px;
            color: #444;
            cursor: pointer;
          }
          
          /* Estilo para o passo atual */
          .passo.current-step {
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
          }
        `;
      }

      // Adicionamos o modal ao corpo do documento se não existir
      let modal = parsedDoc.getElementById('imageModal');
      if (!modal) {
        modal = parsedDoc.createElement('div');
        modal.id = 'imageModal';
        modal.className = 'image-modal';
        modal.innerHTML = `
          <span class="close-modal" onclick="this.parentElement.style.display='none'">&times;</span>
          <img class="modal-content" id="modalImg">
          <div class="modal-caption" id="modalCaption"></div>
        `;
        parsedDoc.body.appendChild(modal);
      }

      // Adicionamos o script para ampliar as imagens
      let script = parsedDoc.getElementById('image-script');
      if (!script) {
        script = parsedDoc.createElement('script');
        script.id = 'image-script';
        script.text = `
          function ampliarImagem(img) {
            var modal = document.getElementById('imageModal');
            var modalImg = document.getElementById('modalImg');
            var captionText = document.getElementById('modalCaption');
            modal.style.display = "block";
            modalImg.src = img.src;
            captionText.innerHTML = img.getAttribute('data-caption') || '';
          }
        `;
        parsedDoc.body.appendChild(script);
      }

      // Encontrar todos os passos no documento
      const passos = parsedDoc.querySelectorAll('.passo');
      
      passos.forEach(passo => {
        // Criar ou limpar o container de thumbnails
        let thumbsContainer = passo.querySelector('.step-thumbnails');
        if (!thumbsContainer) {
          thumbsContainer = parsedDoc.createElement('div');
          thumbsContainer.className = 'step-thumbnails';
          
          // Inserir antes do botão de adicionar foto, se existir
          const addBtn = passo.querySelector('.add-image-btn');
          if (addBtn) {
            passo.insertBefore(thumbsContainer, addBtn);
          } else {
            passo.appendChild(thumbsContainer);
          }
        } else {
          // Limpar container existente (remover tudo que não for .thumbnail-container)
          Array.from(thumbsContainer.children).forEach(child => {
            if (!child.classList.contains('thumbnail-container')) {
              child.remove();
            }
          });
        }
        
        // Processar todas as imagens existentes
        const existingImgs = passo.querySelectorAll('img:not(.step-thumbnail)');
        existingImgs.forEach(img => {
          if (img.closest('.thumbnail-container')) return; // Já está em um container
          if (img.closest('.modal-content')) return; // Está no modal
          
          const caption = img.dataset.caption || '';
          
          // Criar estrutura de thumbnail
          const container = parsedDoc.createElement('div');
          container.className = 'thumbnail-container';
          container.setAttribute('onclick', 'ampliarImagem(this.querySelector("img"))');
          
          // Criar nova imagem com tamanho controlado
          const newImg = parsedDoc.createElement('img');
          newImg.className = 'step-thumbnail';
          newImg.src = img.src;
          newImg.alt = caption;
          newImg.dataset.caption = caption;
          newImg.setAttribute('onclick', 'event.stopPropagation(); ampliarImagem(this)');
          
          container.appendChild(newImg);
          
          // Adicionar legenda se existir
          if (caption) {
            const captionElement = parsedDoc.createElement('div');
            captionElement.className = 'thumbnail-caption';
            captionElement.textContent = caption;
            container.appendChild(captionElement);
          }
          
          // Adicionar ao container de thumbnails
          thumbsContainer.appendChild(container);
          
          // Remover a imagem original
          img.remove();
        });
        
        // Processar todas as imagens existentes no container de thumbnails
        const thumbnails = thumbsContainer.querySelectorAll('.thumbnail-container');
        thumbnails.forEach(container => {
          // Garantir que o container tenha o onclick correto
          container.setAttribute('onclick', 'ampliarImagem(this.querySelector("img"))');
          
          const img = container.querySelector('img');
          if (img) {
            // Garantir que a imagem tenha a classe e o onclick corretos
            img.className = 'step-thumbnail';
            img.setAttribute('onclick', 'event.stopPropagation(); ampliarImagem(this)');
          }
        });
        
        // Garantir que o botão de adicionar foto exista e tenha o estilo correto
        let addBtn = passo.querySelector('.add-image-btn');
        if (!addBtn) {
          addBtn = parsedDoc.createElement('button');
          addBtn.className = 'add-image-btn';
          addBtn.innerHTML = '<i class="fas fa-camera"></i> ';
          addBtn.dataset.stepId = passo.dataset.stepId;
          passo.appendChild(addBtn);
        }
      });
    }

    function showImageModal(stepId, imageUrl = null, caption = '') {
      const modal = document.getElementById('image-modal');
      const modalTitle = document.getElementById('modal-title');
      const imagePreview = document.getElementById('image-preview');
      const captionInput = document.getElementById('caption-input');
      const saveBtn = document.getElementById('save-image-btn');
      const deleteBtn = document.getElementById('delete-image-btn');
      const selectBtn = document.getElementById('select-image-btn');
      
      // Configurar o contexto de edição
      currentImageEditContext = {
        stepId: stepId,
        imageUrl: imageUrl,
        isEdit: !!imageUrl
      };
      
      // Configurar título do modal
      modalTitle.textContent = imageUrl ? 'Editar Imagem' : 'Adicionar Imagem';
      
      // Configurar prévia da imagem
      if (imageUrl) {
        imagePreview.src = imageUrl;
        imagePreview.style.display = 'block';
        selectBtn.style.display = 'none';
      } else {
        imagePreview.src = '#';
        imagePreview.style.display = 'none';
        selectBtn.style.display = 'block';
      }
      
      // Configurar legenda
      captionInput.value = caption;
      
      // Configurar botões
      deleteBtn.style.display = imageUrl ? 'inline-block' : 'none';
      
      // Exibir modal
      modal.style.display = 'block';
    }

    function addThumbnail(container, imageUrl, caption, stepId, index) {
      const thumbnailContainer = document.createElement('div');
      thumbnailContainer.className = 'thumbnail-container';
      thumbnailContainer.dataset.index = index;
      
      const img = document.createElement('img');
      img.className = 'step-thumbnail';
      img.src = imageUrl;
      img.alt = caption;
      img.dataset.caption = caption;
      
      const captionElement = document.createElement('div');
      captionElement.className = 'thumbnail-caption';
      captionElement.textContent = caption;
      
      thumbnailContainer.appendChild(img);
      thumbnailContainer.appendChild(captionElement);
      
      thumbnailContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        showImageModal(stepId, imageUrl, caption);
      });
      
      container.appendChild(thumbnailContainer);
      return thumbnailContainer;
    }

    function saveImage() {
      if (!currentImageEditContext) return;
      
      const { stepId, imageUrl, isEdit } = currentImageEditContext;
      const imageInput = document.getElementById('image-input');
      const captionInput = document.getElementById('caption-input');
      const caption = captionInput.value.trim();
      
      // Encontrar o passo correspondente
      const passoElement = document.querySelector(`.passo[data-step-id="${stepId}"]`);
      if (!passoElement) {
        showNotification('Erro: Passo não encontrado.', 'error');
        closeImageModal();
        return;
      }
      
      // Obter ou criar o contêiner de miniaturas
      let thumbnailsContainer = passoElement.querySelector('.step-thumbnails');
      if (!thumbnailsContainer) {
        thumbnailsContainer = document.createElement('div');
        thumbnailsContainer.className = 'step-thumbnails';
        
        // Inserir antes do botão de adicionar foto, se existir
        const addImageBtn = passoElement.querySelector('.add-image-btn');
        if (addImageBtn) {
          passoElement.insertBefore(thumbnailsContainer, addImageBtn);
        } else {
          passoElement.appendChild(thumbnailsContainer);
        }
      }
      
      if (isEdit) {
        // Atualizar imagem existente
        const existingThumbnails = thumbnailsContainer.querySelectorAll('.thumbnail-container');
        for (const container of existingThumbnails) {
          const thumb = container.querySelector('img');
          if (thumb && thumb.src === imageUrl) {
            thumb.dataset.caption = caption;
            thumb.alt = caption;
            const captionElement = container.querySelector('.thumbnail-caption');
            if (captionElement) {
              captionElement.textContent = caption;
            }
            break;
          }
        }
        
        showNotification('Legenda atualizada com sucesso!', 'success');
      } else if (imageInput.files && imageInput.files[0]) {
        // Adicionar nova imagem
        const file = imageInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const newImageUrl = e.target.result;
          const index = thumbnailsContainer.querySelectorAll('.thumbnail-container').length;
          addThumbnail(thumbnailsContainer, newImageUrl, caption, stepId, index);
          
          showNotification('Imagem adicionada com sucesso!', 'success');
          
          // Sincronizar imediatamente com parsedDoc para adicionar a imagem ao HTML
          sincronizarFotosComParsedDoc();
        };
        
        reader.readAsDataURL(file);
      } else {
        showNotification('Por favor, selecione uma imagem.', 'error');
        return;
      }
      
      unsavedChanges = true;
      
      // Sincronizar imediatamente com parsedDoc para garantir que as mudanças sejam salvas
      sincronizarFotosComParsedDoc();
      
      closeImageModal();
    }

    function deleteImage() {
      if (!currentImageEditContext || !currentImageEditContext.imageUrl) return;
      
      const { stepId, imageUrl } = currentImageEditContext;
      
      // Encontrar o passo correspondente
      const passoElement = document.querySelector(`.passo[data-step-id="${stepId}"]`);
      if (!passoElement) {
        closeImageModal();
        return;
      }
      
      // Encontrar e remover a miniatura
      const thumbnailsContainer = passoElement.querySelector('.step-thumbnails');
      if (thumbnailsContainer) {
        const thumbnails = thumbnailsContainer.querySelectorAll('.thumbnail-container');
        for (const thumbnail of thumbnails) {
          const img = thumbnail.querySelector('img');
          if (img && img.src === imageUrl) {
            thumbnail.remove();
            break;
          }
        }
      }
      
      showNotification('Imagem excluída com sucesso!', 'success');
      unsavedChanges = true;
      
      // Sincronizar imediatamente com parsedDoc para garantir que a exclusão seja salva
      sincronizarFotosComParsedDoc();
      
      closeImageModal();
    }

    function closeImageModal() {
      document.getElementById('image-modal').style.display = 'none';
      document.getElementById('image-input').value = '';
      currentImageEditContext = null;
    }

    function openPdfModal() {
      const modal = document.getElementById('pdf-modal');
      const groupsSelection = document.getElementById('pdf-groups-selection');
      
      // Limpar seleções anteriores
      groupsSelection.innerHTML = '';
      
      // Adicionar opções para cada grupo no dashboard
      const groups = document.querySelectorAll('#dashboard-content .group-section');
      groups.forEach(group => {
        const groupHeader = group.querySelector('.group-header');
        if (!groupHeader) return;
        
        const groupName = groupHeader.textContent.trim();
        const groupColor = groupHeader.style.backgroundColor;
        
        const groupItem = document.createElement('div');
        groupItem.className = 'pdf-group-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `pdf-group-${groupName.replace(/\s+/g, '-')}`;
        checkbox.value = groupName;
        checkbox.checked = true;
        checkbox.dataset.color = groupColor;
        
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = groupName;
        label.style.color = groupColor;
        
        groupItem.appendChild(checkbox);
        groupItem.appendChild(label);
        groupsSelection.appendChild(groupItem);
      });
      
      // Atualizar visibilidade da seleção de grupos
      document.getElementById('pdf-select-groups').onchange = function() {
        groupsSelection.style.display = this.checked ? 'block' : 'none';
      };
      
      document.getElementById('pdf-all').onchange = function() {
        groupsSelection.style.display = 'none';
      };
      
      // Garantir que a visibilidade inicial está correta
      groupsSelection.style.display = document.getElementById('pdf-select-groups').checked ? 'block' : 'none';
      
      modal.style.display = 'block';
    }

    function generatePdf() {
      // Verificar se deseja todos os grupos ou apenas selecionados
      const selectAllGroups = document.getElementById('pdf-all').checked;
      let selectedGroups = [];
      
      if (!selectAllGroups) {
        // Obter grupos selecionados
        document.querySelectorAll('#pdf-groups-selection input:checked').forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        if (selectedGroups.length === 0) {
          showNotification('Por favor, selecione pelo menos um grupo para o PDF.', 'error');
          return;
        }
      }
      
      // Fechar o modal
      document.getElementById('pdf-modal').style.display = 'none';
      
      // Preparar o conteúdo do PDF
      const pdfContent = document.createElement('div');
      pdfContent.style.padding = '20px';
      pdfContent.style.fontFamily = 'Arial, sans-serif';
      
      // Adicionar estilos CSS otimizados para PDF
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        /* Estilos otimizados para o relatório PDF */
        .pdf-header {
          text-align: center;
          margin-bottom: 20px;
        }
        
        .pdf-title {
          margin-bottom: 5px;
        }
        
        .pdf-subtitle {
          margin-bottom: 10px;
        }
        
        .pdf-info {
          margin-bottom: 5px;
        }
        
        .pdf-group {
          margin-bottom: 20px;
          page-break-before: auto;
          page-break-inside: avoid;
        }
        
        /* Regra importante: não quebrar página antes do primeiro grupo */
        .pdf-group:first-child {
          page-break-before: auto;
        }
        
        .pdf-group-header {
          page-break-after: avoid;
          page-break-inside: avoid;
        }
        
        .pdf-goal {
          margin-bottom: 15px;
          page-break-inside: avoid;
        }
        
        .pdf-goal-title {
          font-size: 16pt;
          padding: 8px;
          margin-bottom: 20px;
          color: white;
          border-radius: 5px;
        }
        
        .pdf-step {
          margin-left: 15px;
          margin-bottom: 12px;
          padding: 10px;
          background: #f9f9f9;
          border-radius: 5px;
          border-left: 3px solid #4c956c;
          page-break-inside: avoid;
        }
        
        .pdf-step-incomplete {
          background-color: #FFCCCC !important;
          border-left-color: #d83367 !important;
        }
        
        /* Estilo para o passo atual no PDF */
        .pdf-step-current {
          background-color: #f9f9f9 !important;
          border-left: 5px solid #4CAF50 !important;
        }
        
        .pdf-step-content {
          margin-bottom: 8px;
        }
        
        .pdf-step-comment {
          margin-top: 5px;
          color: #d83367;
          font-style: italic;
        }
        
        .pdf-images {
          margin-top: 10px;
          gap: 10px;
        }
        
        .pdf-image-container {
          margin-bottom: 8px;
        }
        
        @page {
          margin: 1cm;
          orphans: 3;
          widows: 2;
        }
      `;
      
      pdfContent.appendChild(styleElement);
      
      // Adicionar cabeçalho com informações atualizadas do usuário e data
      const formattedDate = new Date(currentDate).toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      
      const formattedTime = new Date(currentDate).toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const header = document.createElement('div');
      header.className = 'pdf-header';
      header.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
          <img src="https://i.imgur.com/t07ofJe.jpeg" alt="Logo ICMBio" style="height:100px; margin-bottom:15px;">
          <h1 class="pdf-title" style="font-size:24pt; margin-bottom:5px; color:#2c3e50;">Área de Proteção Ambiental Delta do Parnaíba</h1>
          <p class="pdf-subtitle" style="font-size:16pt; margin-bottom:15px; color:#34495e;">Relatório de Atividades e Metas</p>
          <p class="pdf-info" style="font-size:10pt; color:#7f8c8d;">Data de geração: ${formattedDate} às ${formattedTime}</p>
          <p class="pdf-info" style="font-size:10pt; color:#7f8c8d;">Usuário: ${currentUser}</p>
        </div>
      `;
      pdfContent.appendChild(header);
      
      // Adicionar grupos e metas
      const dashboard = document.getElementById('dashboard-content');
      const groups = dashboard.querySelectorAll('.group-section');
      
      // Contador para verificar se encontramos conteúdo
      let groupCount = 0;
      
      groups.forEach((group, index) => {
        const groupHeader = group.querySelector('.group-header');
        if (!groupHeader) return;
        
        const groupName = groupHeader.textContent.trim();
        const groupColor = groupHeader.style.backgroundColor;
        
        // Verificar se o grupo está selecionado
        if (!selectAllGroups && !selectedGroups.includes(groupName)) return;
        
        // Incrementar contador de grupos
        groupCount++;
        
        const groupSection = document.createElement('div');
        groupSection.className = 'pdf-group';
        
        // Adicionar título do grupo
        const groupTitle = document.createElement('h2');
        groupTitle.className = 'pdf-group-header';
        groupTitle.textContent = groupName;
        groupTitle.style.backgroundColor = groupColor;
        groupTitle.style.color = 'white';
        groupTitle.style.padding = '10px 15px';
        groupTitle.style.borderRadius = '5px';
        
        groupSection.appendChild(groupTitle);
        
        // Adicionar metas e passos
        const metasAndSteps = group.querySelectorAll('.meta-and-steps');
        metasAndSteps.forEach(metaAndSteps => {
          const metaButton = metaAndSteps.querySelector('.meta-button');
          if (!metaButton) return;
          
          const metaName = metaButton.textContent.trim();
          
          const metaDiv = document.createElement('div');
          metaDiv.className = 'pdf-goal';
          
          // Adicionar título da meta
          const metaTitle = document.createElement('h3');
          metaTitle.className = 'pdf-goal-title';
          metaTitle.textContent = metaName;
          metaTitle.style.backgroundColor = groupColor;
          metaTitle.style.color = 'white';
          metaTitle.style.padding = '8px';
          metaTitle.style.borderRadius = '5px';
          
          metaDiv.appendChild(metaTitle);
          
          // Adicionar passos
          const passos = metaAndSteps.querySelectorAll('.passo');
          passos.forEach((passo, index) => {
            const passoDiv = document.createElement('div');
            passoDiv.className = 'pdf-step';
            
            // Verificar se o passo não está concluído (tem fundo rosa)
            const bgColor = passo.style.background || passo.style.backgroundColor;
            const isIncomplete = bgColor && (bgColor.includes('FFCCCC') || bgColor === '#FFCCCC' || bgColor === 'rgb(255, 204, 204)');
            
            // Verificar se é um passo atual
            const isCurrent = passo.classList.contains('current-step');
            
            if (isIncomplete) {
              passoDiv.className += ' pdf-step-incomplete';
            }
            
            if (isCurrent) {
              passoDiv.className += ' pdf-step-current';
            }
            
            // Adicionar conteúdo do passo
            const stepNumber = index + 1;
            const stepContent = passo.querySelector('p')?.textContent || '';
            const stepComment = passo.querySelector('.comentario')?.textContent || '';
            
            // Adicionar indicador visual para passos atuais
            const currentIndicator = isCurrent ? ' (Atual)' : '';
            
            passoDiv.innerHTML = `
              <div class="pdf-step-content">
                <strong>Passo ${stepNumber}${currentIndicator}:</strong> ${stepContent}
              </div>
              ${stepComment ? `<div class="pdf-step-comment">${stepComment}</div>` : ''}
            `;
            
            // Adicionar imagens se existirem
            const thumbnails = passo.querySelectorAll('.thumbnail-container');
            if (thumbnails.length > 0) {
              const imagesDiv = document.createElement('div');
              imagesDiv.className = 'pdf-images';
              
              thumbnails.forEach(thumbnail => {
                const img = thumbnail.querySelector('img');
                if (!img) return;
                
                const imageUrl = img.src;
                const caption = img.dataset.caption || '';
                
                const imageContainer = document.createElement('div');
                imageContainer.className = 'pdf-image-container';
                
                const pdfImage = document.createElement('img');
                pdfImage.className = 'pdf-image';
                pdfImage.src = imageUrl;
                pdfImage.alt = caption;
                
                const pdfCaption = document.createElement('div');
                pdfCaption.className = 'pdf-caption';
                pdfCaption.textContent = caption;
                
                imageContainer.appendChild(pdfImage);
                imageContainer.appendChild(pdfCaption);
                imagesDiv.appendChild(imageContainer);
              });
              
              passoDiv.appendChild(imagesDiv);
            }
            
            metaDiv.appendChild(passoDiv);
          });
          
          groupSection.appendChild(metaDiv);
        });
        
        pdfContent.appendChild(groupSection);
      });
      
      // Verificar se encontramos algum grupo
      if (groupCount === 0) {
        showNotification('Não foi possível gerar o PDF. Nenhum grupo selecionado foi encontrado.', 'error');
        return;
      }
      
      // Gerar PDF com configurações otimizadas
      const opt = {
        margin: [10, 10],
        filename: `Relatório_APA_Delta_Parnaiba_${formattedDate.replace(/\//g, '-')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2, 
          useCORS: true,
          allowTaint: true 
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        },
        pagebreak: { 
          mode: ['avoid-all', 'css', 'legacy'] 
        }
      };
      
      html2pdf().from(pdfContent).set(opt).save();
      showNotification('Gerando PDF, por favor aguarde...', 'success');
    }

    function switchView(view) {
      document.getElementById('upload-section').style.display = view === 'upload' ? 'block' : 'none';
      document.getElementById('dashboard').style.display = view === 'dashboard' ? 'block' : 'none';
    }

    // Event Listeners
    document.getElementById('load-html-btn').onclick = () => document.getElementById('html-file-input').click();

    document.getElementById('html-file-input').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = ev => {
        parsedDoc = new DOMParser().parseFromString(ev.target.result, 'text/html');
        ensureStepIds(); // Garantir IDs ao carregar
        
        // Garantir que todos os passos tenham um contêiner de thumbnails e botão de adicionar foto
        parsedDoc.querySelectorAll('.passo').forEach(passo => {
          const stepId = passo.dataset.stepId;
          
          // Adicionar botão de adicionar foto se não existir
          if (!passo.querySelector('.add-image-btn')) {
            const addImageBtn = parsedDoc.createElement('button');
            addImageBtn.className = 'add-image-btn';
            addImageBtn.innerHTML = '<i class="fas fa-camera"></i> ';
            addImageBtn.dataset.stepId = stepId;
            passo.appendChild(addImageBtn);
          }
        });
        
        generateDashboardContent();
        switchView('dashboard');
        showNotification('HTML carregado com sucesso! IDs gerados para passos sem identificação', 'success');
      };
      reader.readAsText(file);
    };

    document.getElementById('add-group-btn').onclick = addNewGroup;

    document.getElementById('save-btn').onclick = () => {
      saveAll();
      redimensionarImagensNoHtml(); // Chamar a função para redimensionar as imagens
      
      const html = parsedDoc.documentElement.outerHTML;
      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'delta_metas_atualizado.html';
      a.click();
      showNotification('Arquivo HTML salvo com sucesso! Imagens redimensionadas.', 'success');
    };

    document.getElementById('generate-pdf-btn').onclick = openPdfModal;

    // Event listeners para o modal de imagem
    document.querySelector('#image-modal .close').onclick = closeImageModal;
    document.getElementById('cancel-image-btn').onclick = closeImageModal;
    document.getElementById('save-image-btn').onclick = saveImage;
    document.getElementById('delete-image-btn').onclick = deleteImage;

    document.getElementById('select-image-btn').onclick = () => {
      document.getElementById('image-input').click();
    };

    document.getElementById('image-input').onchange = function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('image-preview').src = e.target.result;
          document.getElementById('image-preview').style.display = 'block';
          document.getElementById('select-image-btn').style.display = 'none';
        };
        reader.readAsDataURL(this.files[0]);
      }
    };

    // Event listeners para o modal de novo passo
    document.getElementById('close-step-modal').onclick = () => {
      document.getElementById('new-step-modal').style.display = 'none';
    };
    
    document.getElementById('cancel-step-btn').onclick = () => {
      document.getElementById('new-step-modal').style.display = 'none';
    };
    
    document.getElementById('save-step-btn').onclick = saveNewStep;
    
    // Event listeners para o modal de nova meta
    document.getElementById('close-meta-modal').onclick = () => {
      document.getElementById('new-meta-modal').style.display = 'none';
    };
    
    document.getElementById('cancel-meta-btn').onclick = () => {
      document.getElementById('new-meta-modal').style.display = 'none';
    };
    
    document.getElementById('save-meta-btn').onclick = saveNewMeta;

    // Event listeners para o modal de PDF
    document.getElementById('close-pdf-modal').onclick = () => {
      document.getElementById('pdf-modal').style.display = 'none';
    };
    document.getElementById('generate-pdf-confirm').onclick = generatePdf;
    document.getElementById('cancel-pdf').onclick = () => {
      document.getElementById('pdf-modal').style.display = 'none';
    };

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveAll();
        redimensionarImagensNoHtml(); // Redimensionar imagens ao salvar com Ctrl+S
        const html = parsedDoc.documentElement.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'delta_metas_atualizado.html';
        a.click();
        showNotification('Arquivo HTML salvo com sucesso! (Ctrl+S)', 'success');
      }
    });

    switchView('upload');
    showNotification('Atualizador Delta Metas Unificado carregado!', 'info', 2000);

    // Atualização dos dados de usuário e data para uso nas funções que geram documentos
    document.addEventListener('DOMContentLoaded', () => {
      console.log(`Sistema iniciado: ${currentDate} por ${currentUser}`);
    });
  </script>
</body>
</html>